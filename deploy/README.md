# OpenWeb Deployment Runbook (Docker Compose + Docker Swarm)

This runbook covers everything needed to run OpenWeb in production-like Docker environments.

## Quick start (interactive)

Use the root setup script:

```bash
./setup-deploy.sh
```

The script will prompt for:

- Postgres DB name
- Postgres username
- Postgres password
- Deploy mode: Docker Compose or Docker Swarm
- Optional backup ZIP path to restore before setup completes

`JWT_SECRET` is auto-generated by the script.

## What this stack includes

- NGINX reverse proxy with multi-worker + threaded I/O config.
- API service (Fastify).
- Web service (static SPA via NGINX).
- Postgres database.
- Redis service.
- Optional autoscaler (Swarm mode only).
- Backup/restore via CLI scripts and Admin Panel ZIP management.

## Prerequisites

- Docker Engine 24+ (or current stable).
- Docker Compose plugin (`docker compose`).
- For Swarm mode: one manager node (single node is fine to start).
- Open ports:
  - `80/tcp` for app traffic.

## Important paths

- Compose file: `deploy/docker-compose.yml`
- Swarm stack file: `deploy/docker-stack.yml`
- Env template: `deploy/.env.example`
- NGINX config: `deploy/nginx/`

## 1) Configure environment

```bash
cp deploy/.env.example deploy/.env
```

Edit `deploy/.env` and set at least:

- `POSTGRES_DB`
- `POSTGRES_USER`
- `POSTGRES_PASSWORD`
- `JWT_SECRET`

For Swarm autoscaling, also tune as needed:

- `API_MIN_REPLICAS`, `API_MAX_REPLICAS`
- `WEB_MIN_REPLICAS`, `WEB_MAX_REPLICAS`
- `SCALE_UP_CPU`, `SCALE_DOWN_CPU`
- `CHECK_INTERVAL_SECONDS`, `COOLDOWN_SECONDS`

## 2) Deploy with Docker Compose (single-node)

### Start services

```bash
docker compose -f deploy/docker-compose.yml --env-file deploy/.env up -d --build
```

### Run DB migrations (required on first deploy / schema changes)

```bash
source deploy/.env
for f in $(ls apps/api/drizzle/*.sql | sort); do
  echo "Applying $f"
  docker compose -f deploy/docker-compose.yml --env-file deploy/.env exec -T postgres \
    psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" < "$f"
done
```

### Verify services

```bash
docker compose -f deploy/docker-compose.yml --env-file deploy/.env ps
curl -sS http://localhost/health
```

### First-time app setup

- Open `http://localhost/setup`
- Create the first admin account.
- Admin UI: `http://localhost/admin`

### Compose operations

- View logs:
  ```bash
  docker compose -f deploy/docker-compose.yml --env-file deploy/.env logs -f
  ```
- Manual scaling (compose mode):
  ```bash
  docker compose -f deploy/docker-compose.yml --env-file deploy/.env up -d --scale api=3 --scale web=3
  ```
- Stop:
  ```bash
  docker compose -f deploy/docker-compose.yml --env-file deploy/.env down
  ```

## 3) Deploy with Docker Swarm (autoscaling supported)

Swarm mode is required for automatic scaling.

### Build images

```bash
docker build -f apps/api/Dockerfile -t openweb-api:latest .
docker build -f apps/web/Dockerfile -t openweb-web:latest .
docker build -f deploy/autoscaler/Dockerfile -t openweb-autoscaler:latest .
```

### Initialize swarm (once per manager)

```bash
docker swarm init
```

### Export env and deploy stack

```bash
set -a
source deploy/.env
set +a

docker stack deploy -c deploy/docker-stack.yml openweb
```

### Run DB migrations in Swarm

```bash
source deploy/.env
POSTGRES_CONTAINER=$(docker ps -q --filter label=com.docker.swarm.service.name=openweb_postgres | head -n 1)

for f in $(ls apps/api/drizzle/*.sql | sort); do
  echo "Applying $f"
  docker exec -i "$POSTGRES_CONTAINER" psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" < "$f"
done
```

### Verify Swarm services

```bash
docker stack services openweb
docker service ps openweb_proxy
curl -sS http://localhost/health
```

### Swarm operations

- View service logs:
  ```bash
  docker service logs -f openweb_api
  docker service logs -f openweb_web
  docker service logs -f openweb_autoscaler
  ```
- Manual scale override:
  ```bash
  docker service scale openweb_api=4
  docker service scale openweb_web=4
  ```
- Remove stack:
  ```bash
  docker stack rm openweb
  ```

## 4) Autoscaling behavior (Swarm only)

Autoscaler service checks CPU for `openweb_api` and `openweb_web` on an interval.

- Scale up: CPU >= `SCALE_UP_CPU` and below max replicas.
- Scale down: CPU <= `SCALE_DOWN_CPU` and above min replicas.
- Cooldown enforced by `COOLDOWN_SECONDS`.
- Scaling step is `+1` or `-1` replica per cycle.

## 5) Backups and restore

### Admin Panel (recommended)

Go to `Admin -> System -> Backups`:

- `Create ZIP backup`
- `Download` backup ZIP
- `Upload & restore ZIP`

Restore replaces database content and uploads with selected backup.

### CLI backup/restore scripts

- Create backup:
  ```bash
  ./deploy/scripts/backup.sh
  ```
- Restore backup:
  ```bash
  ./deploy/scripts/restore.sh backups/<timestamp>
  ```

### What backups contain

- Database SQL dump
- Uploads directory
- Code snapshot
- Backup manifest metadata

## 6) Persistent data

Docker volumes persist state:

- `postgres_data`
- `redis_data`
- `uploads_data`
- `backups_data`

## 7) Updates / redeploy flow

### Compose

```bash
git pull
docker compose -f deploy/docker-compose.yml --env-file deploy/.env up -d --build
# run migrations if schema changed
```

### Swarm

```bash
git pull
docker build -f apps/api/Dockerfile -t openweb-api:latest .
docker build -f apps/web/Dockerfile -t openweb-web:latest .
docker build -f deploy/autoscaler/Dockerfile -t openweb-autoscaler:latest .

set -a
source deploy/.env
set +a

docker stack deploy -c deploy/docker-stack.yml openweb
# run migrations if schema changed
```

## Notes

- Redis is provisioned and compatible via `REDIS_URL` wiring.
- API currently does not require Redis to boot.
- Keep `JWT_SECRET` and DB credentials private.
